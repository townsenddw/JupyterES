namespace: ${namespace}
stacker_bucket: ${stacker_bucket_name}

common: &common
  KeyName: townsenddw
  #Amazon EKS-optimized AMI version 1.11 01-01-2019
  NodeImageId: ${node_image_id}
  NodeAutoScalingGroupMaxSize: 5
  NodeAutoScalingGroupDesiredCapacity: 1
  ClusterName: ${rxref eks-cluster::ClusterName}
  ClusterControlPlaneSecurityGroup: ${rxref vpc::SecurityGroups}
  VpcId: ${rxref vpc::VpcId}
  Subnets: ${rxref vpc::SubnetIds}
  NodeVolumeSize: 150
  NodeInstanceProfile: ${rxref node-role::NodeInstanceProfile}
  NodeInstanceRole: ${rxref node-role::NodeInstanceRole}
  NodeSecurityGroup: ${rxref node-role::NodeSecurityGroup}

pre_build:

  - path: hooks.eks.installConfigMap
    required: false
    enabled: true
    args:
      clusterName: ${cluster_name}
      nodeArn: ${node_arn}
  # - path: hooks.eks.installHelm
  #   enabled: true
  - path: stacker.hooks.command.run_command
    required: true
    enabled: true
    args:
      command: ['kubectl', 'apply', '-f', 'hooks/storageclass.yaml']

stacks:

  bastion:
    template_path: templates/bastion.yaml
    variables:
      << : *common
      NodeImageId: ami-01bbe152bf19d0289
      NodeInstanceType: t3.micro
      NodeAutoScalingGroupMaxSize: 1
      NodeGroupName: bastion

  m5-2xlarge-spot:
    template_path: templates/eks-nodegroup.yaml
    variables:
      << : *common
      NodeAutoScalingGroupMinSize: 0
      NodeInstanceType: m5.2xlarge
      NodeGroupName: spot-m5-2xlarge
      SpotPrice: '0.30'

  c5-2xlarge-spot:
    template_path: templates/eks-nodegroup.yaml
    variables:
      << : *common
      NodeAutoScalingGroupMinSize: 0
      NodeInstanceType: c5.2xlarge
      NodeGroupName: spot-c5-2xlarge
      SpotPrice: '0.30'

  r4-2xlarge-spot:
    template_path: templates/eks-nodegroup.yaml
    variables:
      << : *common
      NodeAutoScalingGroupMaxSize: 10
      NodeAutoScalingGroupMinSize: 3
      NodeInstanceType: r4.2xlarge
      NodeGroupName: spot-r4-2xlarge
      SpotPrice: '0.30'

  t2-medium-spot:
    template_path: templates/eks-nodegroup.yaml
    variables:
      << : *common
      BootstrapArguments: --kubelet-extra-args '--node-labels=hub.jupyter.org/node-purpose=user --register-with-taints=hub.jupyter.org/dedicated=user:NoSchedule'
      NodeAutoScalingGroupMaxSize: 0
      NodeAutoScalingGroupMinSize: 0
      NodeInstanceType: t2.medium
      NodeGroupName: spot-t2-medium
      NodeVolumeSize: 30
      SpotPrice: '0.30'

  t2-medium-od:
    template_path: templates/eks-nodegroup-od.yaml
    variables:
      << : *common
      BootstrapArguments: --kubelet-extra-args '--node-labels=hub.jupyter.org/node-purpose=user --register-with-taints=hub.jupyter.org/dedicated=user:NoSchedule'
      NodeAutoScalingGroupMaxSize: 0
      NodeAutoScalingGroupMinSize: 0
      NodeInstanceType: t2.medium
      NodeGroupName: od-t2-medium
      NodeVolumeSize: 30